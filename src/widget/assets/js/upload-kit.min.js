!function($){jQuery.fn.yiiUploadKit=function(options){var $input=this,$container=$input.parent("div"),$files=$("<ul>",{"class":"files"}).insertBefore($input),$emptyInput=$container.find(".empty-value"),$fileupload,methods={init:function(){options.multiple&&($input.attr("multiple",!0),$input.attr("name",$input.attr("name")+"[]")),$container.addClass("upload-kit"),options.sortable&&$files.sortable({placeholder:"upload-kit-item sortable-placeholder",tolerance:"pointer",forcePlaceholderSize:!0,update:function(){methods.updateOrder()}}),$input.wrapAll($('<li class="upload-kit-input"></div>')).after($('<span class="glyphicon glyphicon-plus-sign add"></span>')).after($('<span class="glyphicon glyphicon-circle-arrow-down drag"></span>')).after($('<span class="glyphicon glyphicon-ban-circle cancel"></span>')).after($("<span/>",{"data-toggle":"popover","class":"glyphicon glyphicon-exclamation-sign error-popover"})).after('<div class="progress"><div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div></li>'),$files.on("click",".upload-kit-item .remove",methods.removeItem),methods.checkInputVisibility(),methods.fileuploadInit(),methods.dragInit(),!options.acceptFileTypes||options.acceptFileTypes instanceof RegExp||(options.acceptFileTypes=new RegExp(eval(options.acceptFileTypes)))},fileuploadInit:function(){$fileupload=$input.fileupload({name:options.name||"file",url:options.url,dropZone:$input.parents(".upload-kit-input"),dataType:"json",singleFileUploads:!1,multiple:options.multiple,maxNumberOfFiles:options.maxNumberOfFiles,maxFileSize:options.maxFileSize,acceptFileTypes:options.acceptFileTypes,minFileSize:options.minFileSize,messages:options.messages,process:!0,getNumberOfFiles:methods.getNumberOfFiles,start:function(e,i){$fileupload.data(i),$container.find(".upload-kit-input").removeClass("error").addClass("in-progress"),$input.trigger("start"),void 0!==options.start&&options.start(e,i)},processfail:function(e,i){i.files.error&&methods.showError(i.files[0].error)},progressall:function(e,i){var t=parseInt(i.loaded/i.total*100,10);$container.find(".progress-bar").attr("aria-valuenow",t).css("width",t+"%").text(t+"%")},done:function(e,i){$.each(i.result.files,function(e,i){if(i.error)methods.showError(i.errors);else{var t=methods.createItem(i);t.appendTo($files)}}),methods.handleEmptyValue(),methods.checkInputVisibility(),$input.trigger("done"),void 0!==options.done&&options.done(e,i)},fail:function(e,i){methods.showError(i.errorThrown),void 0!==options.fail&&options.fail(e,i)},always:function(e,i){$container.find(".upload-kit-input").removeClass("in-progress"),$input.trigger("always"),void 0!==options.always&&options.always(e,i)}}),$fileupload.on("fileuploadadd",function(e,i){$fileupload.data(i),$input.trigger("add"),void 0!==options.add&&options.add(e,i)}),options.files&&(options.files.sort(function(e,i){return parseInt(e.order)-parseInt(i.order)}),$fileupload.fileupload("option","done").call($fileupload,$.Event("done"),{result:{files:options.files}}),methods.handleEmptyValue(),methods.checkInputVisibility()),$container.on("click",".cancel",function(){$fileupload.abort&&$fileupload.abort()})},dragInit:function(){$(document).on("dragover",function(){$(".upload-kit-input").addClass("drag-highlight")}),$(document).on("dragleave drop",function(){$(".upload-kit-input").removeClass("drag-highlight")})},showError:function(e){$.fn.popover&&$container.find(".error-popover").attr("data-content",e).popover({html:!0,trigger:"hover"}),$container.find(".upload-kit-input").addClass("error")},removeItem:function(e){var i=$(this),t=i.data("url");t&&$.ajax({url:t,type:"DELETE"}),i.parents(".upload-kit-item").remove(),methods.handleEmptyValue(),methods.checkInputVisibility()},createItem:function(e){var i=options.name,t=methods.getNumberOfFiles();options.multiple&&(i+="["+t+"]");var o=$("<li>",{"class":"upload-kit-item done"}).append($("<input/>",{name:i+"[path]",value:e.path,type:"hidden"})).append($("<input/>",{name:i+"[name]",value:e.name,type:"hidden"})).append($("<input/>",{name:i+"[size]",value:e.size,type:"hidden"})).append($("<input/>",{name:i+"[type]",value:e.type,type:"hidden"})).append($("<input/>",{name:i+"[order]",value:e.order,type:"hidden","data-role":"order"})).append($("<input/>",{name:i+"[base_url]",value:e.base_url,type:"hidden"})).append($("<span/>",{"class":"name",title:e.name})).append($("<span/>",{"class":"glyphicon glyphicon-remove-circle remove","data-url":e.delete_url}));return e.type&&-1===e.type.search(/image\/.*/g)?(o.removeClass("image").addClass("not-image"),o.css("backgroundImage",""),o.find("span.name").text(e.name)):(o.removeClass("not-image").addClass("image"),o.prepend($("<img/>",{src:e.base_url+"/"+e.path})),o.find("span.type").text("")),o},checkInputVisibility:function(){var e=$container.find(".upload-kit-input");options.maxNumberOfFiles&&methods.getNumberOfFiles()>=options.maxNumberOfFiles?e.hide():e.show()},handleEmptyValue:function(){methods.getNumberOfFiles()>0?$emptyInput.val(methods.getNumberOfFiles()):$emptyInput.removeAttr("value")},getNumberOfFiles:function(){return $container.find(".files .upload-kit-item").length},updateOrder:function(){$files.find(".upload-kit-item").each(function(e,i){$(i).find("input[data-role=order]").val(e)})}};return methods.init.apply(this),this}}(jQuery);